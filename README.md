# MeshBridge: Telegram ↔ Meshtastic Bridge

MeshBridge — это сервис, который:
- Пересылает сообщения из Telegram-групп в каналы Meshtastic и обратно
- Позволяет управлять нодой через личные команды в Telegram
- Отслеживает новые ноды, низкий заряд батареи, прямых соседей и их SNR
- Ведет лог и статистику
- Работает 24/7 в фоне через Docker

---

## Требования

- Стационарная нода (тестировалось на устройстве T-Beam с прошивкой 2.7.11)
- Сервер или ПК (тестировалось на Ubuntu 24.04.3 LTS)
- USB-кабель для подключения ноды к серверу
- Telegram-бот (создаётся за 1 минуту)
- Два Telegram-чата: один для канала 0 (публичный), второй — для канала 1 (приватный)

---

## Шаг 1: Подключите ноду к серверу

1. Подключите ноду к серверу через USB 
(тестировалось на стареньком macbook pro 2013 года в среде виртуализации UTM)

2. Если используете виртуализацию, расшарьте USB порты и пробросте в виртуалку последовательный порт с автоподключением

3. Найдите имя последовательного порта:
   ```bash
   ls /dev/ttyACM*
   ```
   → Обычно это `/dev/ttyACM0`

4. Добавьте текущего пользователя к dialout:
   ```bash
   sudo usermod -aG dialout $USER
   ```
   → Перезагрузите сервер

---

## Шаг 2: Создайте Telegram-бота

1. Напишите в Telegram @BotFather
2. Выполните:
   ```
   /newbot
   ```
3. Следуйте инструкциям, получите токен вида:
   ```
   123456789:ABCdefGhIJKlmNoPQRstUVwXY
   ```
4. В настройках бота обязательно отключите GroupPrivacy, чтобы бот мог читать отправленные в чатах телеграм сообщения.

---

## Шаг 3: Создайте Telegram-чаты и Meshtastic-чат

1. Чат 1 (публичный) — для канала 0 - коннектор общего чата мештастика
   - Создайте группу → запомните Chat ID
2. Чат 2 (приватный) — для канала 1 - для семьи или друзей
   - Создайте группу → запомните Chat ID

> Чтобы узнать Chat ID, напишите в чат с ботом и выполните:
> ```bash
> curl "https://api.telegram.org/bot<ТОКЕН>/getUpdates"
> ```
> → Ищите `"id": -100...`

3. Напишите боту в ЛС, чтобы создать с ним личный чат для команд и отправки и получения директ сообщений.

> Чтобы узнать айди личного можно воспользоваться ботом @userinfobot

3. Добавьте бота в публичный и приватный групповые чаты в телеграм

4. В настройках ноды в разделе каналы создайте канал с ролью Secondary
> канал должен быть вторым после Primary, чтобы ботом он виделся как channel1
> в будущих обновлениях добавлю возможность указывать приватный канал в .env

---

## Шаг 4: Настройте сервер

### 1. Установите зависимости
```bash
sudo apt update
sudo apt install -y docker.io docker-compose python3-pip
sudo systemctl enable docker
```

### 2. Создайте папку проекта
```bash
mkdir ~/meshbridge && cd ~/meshbridge
```

---

## Шаг 5: Разместите файлы в директорию meshbridge и отредактируйте их

### `bot.py`
→ Скачайте или скопируйте содержимое с репозитория

### `requirements.txt`
```txt
meshtastic==2.7.3
python-telegram-bot==21.4
nest-asyncio
pypubsub
```

### `Dockerfile`
```dockerfile
FROM python:3.12-slim

RUN apt-get update && apt-get install -y \
    libusb-1.0-0 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY bot.py .

RUN touch meshbridge.log && chmod 666 meshbridge.log

CMD ["python", "bot.py"]
```

### `docker-compose.yml`
```yaml
services:
  meshbridge:
    build: .
    env_file:
      - .env
    devices:
      - "/dev/ttyACM0:/dev/ttyACM0"
    volumes:
      - "./:/app"
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

### `.env` (пример)
```env
TELEGRAM_BOT_TOKEN=123456789:ABCdefGhIJKlmNoPQRstUVwXY
CHAT_ID_PUBLIC=-1001234567890      # Telegram-чат для публичного канала
CHAT_ID_PRIVATE=-1009876543210     # Telegram-чат для приватного канала
MESH_CHANNEL_PUBLIC=2              # Номер канала в Meshtastic (0–7)
MESH_CHANNEL_PRIVATE=5             # Номер канала в Meshtastic (0–7)
ADMIN_USER_ID=123456789
```

---

## Шаг 6: Запустите сервис

```bash
cd ~/meshbridge
docker compose build
docker compose up -d
```

Проверьте логи:
```bash
tail -f meshbridge.log
```
> все ошибки связанные с protobuf можно игнорировать
> запуск подтверждается сообщением в логе "Application started"
> при внесении изменений в рабочие файлы докер необходимо пересобрать:

```bash
docker compose down
docker system prune -af --volumes
docker compose up -d
```

---

## Шаг 7: Используйте команды

Напишите боту в личные сообщения:

`/help` чтобы получить список всех команд

> для отправки личного сообщения удаленная нода должна быть в базе. Проверить это и узнать ее короткое имя можно командой из списка /help - /dump_cache
> для отправки сообщения в директ другой ноде напишите @КОРОТКОЕ_ИМЯ Текст сообщения
> важно соблюдать регистр символов в имени.

---

## Структура проекта

```
~/meshbridge/
├── bot.py                 # Основной скрипт
├── requirements.txt       # Зависимости Python
├── Dockerfile             # Сборка образа
├── docker-compose.yml     # Запуск контейнера
├── .env                   # Секреты (не шарить)
├── node_names.json        # Кэш имён нод (сохраняется между перезагрузками)
├── favorites.json         # Список избранных нод формируется вручную. Нужен для получения сообщений о низком уровне батарей избранных нод
└── meshbridge.log         # Лог работы
```

---

## Безопасность

- Все команды работают только в личном чате с ботом
- Приватные сообщения (`@Имя`) не видны в группах
- Уведомления о низком заряде приходят только админу

---

## Устранение неполадок

| Проблема | Решение |
|---------|--------|
| `Permission denied: '/dev/ttyACM0'` | Выполните `sudo usermod -aG dialout $USER` и перезагрузитесь |
| Нет имён нод — только HEX | Обновите базу имен | 
| Ручное и автоматическое обновление имен нод в базе | Обновление базв имен происходит раз в пол часа, либо вручную через команду в /help |
| Команды не работают | Убедитесь, что `ADMIN_USER_ID` — это ваш Telegram User ID |

---

## Готово!

Теперь у вас есть полноценный шлюз между Telegram и Meshtastic, который:
- Работает автономно
- Не зависит от BLE
- Позволяет управлять сетью из любого места

Удачи в эксплуатации!

---

> Совет: добавьте `node_names.json` и `favorites.json` в резервную копию — они сохраняют историю имён и настройки между перезапусками.
